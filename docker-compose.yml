version: "3.9"
volumes:
  db_data:

services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: '123456'
      MYSQL_DATABASE: aiarena
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
    ports: ["3306:3306"]
    volumes:
      - db_data:/var/lib/mysql

  backend:
    build: ./backend
    # ä¸å†éœ€è¦å¯¹å¤–æš´éœ²ç«¯å£ï¼Œå› ä¸ºå®ƒåªå’Œ frontend é€šä¿¡
    #ports: ["8000:8000"] 
    depends_on: [db]
    volumes: ["./backend:/app"]
    environment:

      DB_NAME: 'aiarena'
      DB_USER: 'root'
      DB_PASSWORD: '123456'
      DB_HOST: 'db'
      DB_PORT: '3306'
      # åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„ API Key
      OPENAI_API_KEY: 'sk-ser2cEa4NSlALdseJwob4oube3Trg0NOLwvXEH7yUAeYy9k9' 
    # å…³é”®ä¿®æ”¹ï¼š
    # 1. ä½¿ç”¨ bash -c æ¥ç¡®ä¿è„šæœ¬ç”± bash æ‰§è¡Œ
    # 2. ç¡®ä¿ wait-for-db.sh è„šæœ¬åœ¨æœ¬åœ° ./backend æ–‡ä»¶å¤¹ä¸­å­˜åœ¨

    command: >
      bash -c "dos2unix wait-for-db.sh 2>/dev/null || sed -i 's/\r$//' wait-for-db.sh &&
               chmod +x wait-for-db.sh &&
               ./wait-for-db.sh db python manage.py migrate &&
               python manage.py runserver 0.0.0.0:8000"

  frontend: # <-- ðŸŒŸ ç¡®ä¿è¿™é‡Œæœ‰æ­£ç¡®çš„ç¼©è¿›ï¼Œä½¿å…¶æˆä¸º services çš„å­é¡¹
    build:
      context: ./frontend
      args:
        # ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /api/ï¼Œè®©æµè§ˆå™¨ä¸­çš„è¯·æ±‚èµ° nginx çš„ /api/ ä»£ç†åˆ°åŽç«¯
        VITE_API_BASE: /api/
        # è®¾ç½®å…¬å…±è®¿é—®åœ°å€ï¼ˆç”¨äºŽç”Ÿæˆåˆ†äº«é“¾æŽ¥ç­‰ï¼‰- ä½¿ç”¨ DevTunnel å…¬ç½‘åŸŸå
        VITE_PUBLIC_ORIGIN: https://qt5g1b30-8000.asse.devtunnels.ms
    ports: 
      - "0.0.0.0:8000:80"  # æ˜Žç¡®ç»‘å®šåˆ°æ‰€æœ‰æŽ¥å£
    # volumes: ["./frontend:/app"]
    depends_on:
      - backend

