volumes:
  db_data:

services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: '123456'
      MYSQL_DATABASE: aiarena
    command:
      - '--character-set-server=utf8mb4'
      - '--collation-server=utf8mb4_unicode_ci'
    ports: ["3306:3306"]
    volumes:
      - db_data:/var/lib/mysql

  backend:
    build: ./backend
    # 不再需要对外暴露端口，因为它只与 frontend 通信
    #ports: ["8000:8000"]
    depends_on: [db]
    volumes: ["./backend:/app"]
    environment:
      DB_NAME: 'aiarena'
      DB_USER: 'root'
      DB_PASSWORD: '123456'
      DB_HOST: 'db'
      DB_PORT: '3306'
      # 在这里添加您的 API Key
      OPENAI_API_KEY: 'sk-ser2cEa4NSlALdseJwob4oube3Trg0NOLwvXEH7yUAeYy9k9'
      # GitHub OAuth 配置 (将占位值替换成你的实际应用配置)
      GITHUB_CLIENT_ID: 'Ov23li8J7zm7OnqPEL02'
      GITHUB_CLIENT_SECRET: '8eb5be5e9ddd980a53a3cbe83320cb5921c7be8c'
      # GitHub OAuth 回调必须指向后端 API 路由
      # 确保 GitHub OAuth App 的回调设置与此一致
      GITHUB_REDIRECT_URI: 'http://localhost:8000/api/users/github/callback/'
      FRONTEND_URL: 'http://localhost:8000'
    # 关键修改：
    # 1. 使用 bash -c 来确保脚本由 bash 执行
    # 2. 确保 wait-for-db.sh 脚本在本地 ./backend 文件夹中存在
    command: >
     bash -c "dos2unix wait-for-db.sh 2>/dev/null || sed -i 's/\r$//' wait-for-db.sh &&
              chmod +x wait-for-db.sh &&
              ./wait-for-db.sh db python manage.py migrate &&
              python manage.py runserver 0.0.0.0:8000 --noreload"

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports: ["3000:3000"]
    depends_on: [db]
    volumes: 
      - ./src:/app/src
      - ./package.json:/app/package.json
      - ./tsconfig.json:/app/tsconfig.json
      - ./.env:/app/.env
    environment:
      DB_HOST: 'db'
      DB_PORT: '3306'
      DB_USER: 'root'
      DB_PASSWORD: '123456'
      DB_NAME: 'aiarena'
      JWT_SECRET: 'your_jwt_secret_key_change_this_in_production'
      JWT_EXPIRES_IN: '7d'
      NODE_ENV: 'development'
      PORT: '3000'
    command: sh -c "npm install && npm run dev"

  frontend:
    build:
      # --- 关键修改 ---
      # 1. 将 context 设置为 ./frontend
      context: ./frontend
      # 2. Dockerfile 现在就在 context 内部，可以直接指定文件名
      dockerfile: Dockerfile
    ports:
      - "8000:80"
    # --- 关键新增: 使用 volumes 挂载 nginx.conf ---
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - api
